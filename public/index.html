<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Netlify · Projects</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:             #050914;
      --surface:        #0a1022;
      --surface-hover:  #0e1630;
      --border:         #152038;
      --border-active:  #1f3560;
      --text-1:         #dce8fb;
      --text-2:         #6880a8;
      --text-3:         #334260;
      --accent:         #3b82f6;
      --accent-glow:    rgba(59, 130, 246, 0.14);
      --danger:         #f04040;
      --danger-dim:     rgba(240, 64, 64, 0.08);
      --success:        #22d3a0;
      --success-dim:    rgba(34, 211, 160, 0.08);
      --radius:         12px;
    }

    html { font-size: 16px; }

    body {
      background-color: var(--bg);
      color: var(--text-1);
      font-family: 'DM Sans', -apple-system, sans-serif;
      font-weight: 400;
      line-height: 1.6;
      min-height: 100vh;
      background-image:
        radial-gradient(ellipse 70% 40% at 50% 0%, rgba(59, 130, 246, 0.07) 0%, transparent 65%),
        radial-gradient(circle at 15% 80%, rgba(59, 130, 246, 0.04) 0%, transparent 40%);
    }

    /* Top accent line */
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent 0%, var(--accent) 40%, rgba(59, 130, 246, 0.4) 100%);
      z-index: 200;
    }

    /* Subtle dot grid */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background-image: radial-gradient(circle, rgba(21, 32, 56, 0.6) 1px, transparent 1px);
      background-size: 28px 28px;
      pointer-events: none;
      z-index: 0;
    }

    .wrap {
      position: relative;
      z-index: 1;
      max-width: 920px;
      margin: 0 auto;
      padding: 0 48px;
    }

    /* ─── Header ─────────────────────────────── */
    header {
      padding: 60px 0 44px;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 16px;
    }

    .logo-eyebrow {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10.5px;
      font-weight: 500;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--accent);
      opacity: 0.75;
      margin-bottom: 6px;
    }

    header h1 {
      font-family: 'Syne', sans-serif;
      font-size: 30px;
      font-weight: 800;
      letter-spacing: -0.025em;
      color: var(--text-1);
      line-height: 1;
    }

    header h1 .dot { color: var(--accent); }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 9px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 9px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11.5px;
      color: var(--text-2);
      transition: border-color 0.3s;
      white-space: nowrap;
    }

    .status-badge.connected { border-color: rgba(34, 211, 160, 0.2); }
    .status-badge.error     { border-color: rgba(240, 64, 64, 0.2); }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--text-3);
      flex-shrink: 0;
      transition: background 0.3s, box-shadow 0.3s;
    }
    .status-dot.connected { background: var(--success); box-shadow: 0 0 8px rgba(34, 211, 160, 0.6); }
    .status-dot.error     { background: var(--danger); }
    .status-dot.loading   { background: var(--accent); animation: blink 1.1s ease-in-out infinite; }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0.2; }
    }

    /* ─── Divider ─────────────────────────────── */
    .divider {
      height: 1px;
      background: var(--border);
      margin-bottom: 32px;
    }

    /* ─── Toolbar ─────────────────────────────── */
    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .count-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12.5px;
      color: var(--text-2);
    }
    .count-label .num {
      color: var(--text-1);
      font-weight: 500;
    }

    .btn-refresh {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 8px 18px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-2);
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-refresh:hover {
      border-color: var(--border-active);
      color: var(--text-1);
      background: var(--surface);
    }
    .btn-refresh svg { transition: transform 0.5s cubic-bezier(.4,0,.2,1); }
    .btn-refresh:hover svg { transform: rotate(180deg); }
    .btn-refresh:disabled { opacity: 0.4; pointer-events: none; }

    /* ─── Grid ────────────────────────────────── */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
      gap: 12px;
    }

    /* ─── Card ────────────────────────────────── */
    .card {
      position: relative;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px 22px;
      overflow: hidden;
      animation: cardIn 0.35s ease both;
      transition: border-color 0.2s, background 0.2s;
    }

    /* Left accent bar */
    .card::before {
      content: '';
      position: absolute;
      left: 0; top: 10%; bottom: 10%;
      width: 2px;
      background: var(--accent);
      border-radius: 0 2px 2px 0;
      opacity: 0;
      transition: opacity 0.2s, top 0.2s, bottom 0.2s;
    }

    .card:hover { border-color: var(--border-active); background: var(--surface-hover); }
    .card:hover::before { opacity: 0.6; top: 15%; bottom: 15%; }

    .card.is-confirming { border-color: rgba(240, 64, 64, 0.25); background: rgba(240, 64, 64, 0.02); }
    .card.is-confirming::before { background: var(--danger); opacity: 0.8; top: 0; bottom: 0; }

    .card.is-deleting { opacity: 0.45; pointer-events: none; }

    @keyframes cardIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    @keyframes cardOut {
      from { opacity: 1; transform: scale(1);    max-height: 200px; padding: 20px 22px; margin-bottom: 0; }
      to   { opacity: 0; transform: scale(0.95); max-height: 0;     padding: 0;        margin-bottom: -12px; }
    }

    .card.is-deleted {
      animation: cardOut 0.38s cubic-bezier(.4,0,.2,1) forwards;
      overflow: hidden;
    }

    /* Card – main view */
    .card-main { display: flex; flex-direction: column; gap: 9px; }

    .card-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .site-name {
      font-size: 14.5px;
      font-weight: 500;
      color: var(--text-1);
      line-height: 1.35;
      word-break: break-all;
    }

    .btn-delete {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 7px;
      color: var(--text-3);
      cursor: pointer;
      opacity: 0;
      transition: all 0.18s;
    }
    .card:hover .btn-delete { opacity: 1; }
    .btn-delete:hover {
      background: var(--danger-dim);
      border-color: rgba(240, 64, 64, 0.2);
      color: var(--danger);
    }

    .site-url {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--accent);
      text-decoration: none;
      opacity: 0.7;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: opacity 0.15s;
      word-break: break-all;
    }
    .site-url:hover { opacity: 1; }

    .card-meta {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 14px;
      margin-top: 2px;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 11.5px;
      color: var(--text-3);
    }

    /* Card – confirm view */
    .card-confirm {
      display: none;
      flex-direction: column;
      gap: 16px;
    }

    .card.is-confirming .card-main    { display: none; }
    .card.is-confirming .card-confirm { display: flex; }

    .confirm-title {
      font-size: 13.5px;
      font-weight: 500;
      color: var(--text-1);
    }
    .confirm-title strong { color: var(--danger); font-weight: 500; }

    .confirm-sub {
      font-size: 12px;
      color: var(--text-3);
      margin-top: 4px;
      line-height: 1.5;
    }

    .confirm-actions {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
    }

    .btn-cancel {
      padding: 7px 16px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 7px;
      color: var(--text-2);
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.18s;
    }
    .btn-cancel:hover { border-color: var(--border-active); color: var(--text-1); }

    .btn-confirm-delete {
      padding: 7px 18px;
      background: var(--danger-dim);
      border: 1px solid rgba(240, 64, 64, 0.28);
      border-radius: 7px;
      color: var(--danger);
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.18s;
    }
    .btn-confirm-delete:hover {
      background: rgba(240, 64, 64, 0.15);
      border-color: rgba(240, 64, 64, 0.5);
    }

    /* ─── Skeleton ────────────────────────────── */
    .skeleton-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px 22px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .sk {
      border-radius: 5px;
      background: linear-gradient(90deg, var(--border) 0%, var(--border-active) 50%, var(--border) 100%);
      background-size: 300% 100%;
      animation: shimmer 1.6s ease infinite;
    }
    @keyframes shimmer {
      0%   { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* ─── Empty / Error states ────────────────── */
    .empty-state, .error-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 72px 40px;
    }

    .empty-state svg { margin: 0 auto 20px; display: block; opacity: 0.2; }
    .empty-state p   { font-size: 13.5px; color: var(--text-3); line-height: 1.8; }

    .error-state {
      text-align: left;
      padding: 24px 28px;
      background: var(--danger-dim);
      border: 1px solid rgba(240, 64, 64, 0.18);
      border-radius: var(--radius);
    }
    .error-state .err-title { font-size: 14px; font-weight: 500; color: var(--danger); margin-bottom: 8px; }
    .error-state .err-msg {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--text-2);
      line-height: 1.6;
    }

    /* ─── Toast ───────────────────────────────── */
    .toast-container {
      position: fixed;
      bottom: 28px;
      right: 28px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 300;
    }

    .toast {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 11px 18px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 13px;
      color: var(--text-1);
      box-shadow: 0 8px 32px rgba(0,0,0,0.45);
      animation: toastIn 0.3s cubic-bezier(.2,0,0,1) both;
      max-width: 300px;
      pointer-events: none;
    }
    .toast.success { border-color: rgba(34, 211, 160, 0.25); }
    .toast.error   { border-color: rgba(240, 64, 64, 0.25); }

    @keyframes toastIn  { from { opacity: 0; transform: translateX(12px); } to { opacity: 1; transform: none; } }
    @keyframes toastOut { from { opacity: 1; transform: none; } to { opacity: 0; transform: translateX(12px); } }

    /* ─── Footer ──────────────────────────────── */
    footer {
      padding: 44px 0 36px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-3);
    }

    /* ─── Login overlay ──────────────────────── */
    .login-overlay {
      position: fixed;
      inset: 0;
      z-index: 400;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      background-image:
        radial-gradient(ellipse 70% 40% at 50% 0%, rgba(59, 130, 246, 0.07) 0%, transparent 65%);
      animation: fadeIn 0.3s ease both;
    }
    .login-overlay.hidden { display: none; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .login-card {
      width: 100%;
      max-width: 360px;
      padding: 44px 40px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      gap: 28px;
      animation: slideUp 0.35s cubic-bezier(.2,0,0,1) both;
    }

    @keyframes slideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: none; } }

    .login-logo .logo-eyebrow { margin-bottom: 8px; }
    .login-logo h1 {
      font-family: 'Syne', sans-serif;
      font-size: 26px;
      font-weight: 800;
      letter-spacing: -0.025em;
      line-height: 1;
    }
    .login-logo h1 .dot { color: var(--accent); }

    .login-form { display: flex; flex-direction: column; gap: 10px; }

    .login-input {
      width: 100%;
      padding: 11px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 9px;
      color: var(--text-1);
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      letter-spacing: 0.1em;
      outline: none;
      transition: border-color 0.2s;
    }
    .login-input:focus { border-color: var(--accent); }
    .login-input::placeholder { color: var(--text-3); letter-spacing: 0; }

    .btn-unlock {
      padding: 11px;
      background: var(--accent);
      border: none;
      border-radius: 9px;
      color: #fff;
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .btn-unlock:hover    { opacity: 0.88; }
    .btn-unlock:disabled { opacity: 0.45; cursor: default; }

    .login-error {
      font-size: 12.5px;
      color: var(--danger);
      text-align: center;
      min-height: 18px;
      font-family: 'JetBrains Mono', monospace;
    }

    /* ─── Responsive ──────────────────────────── */
    @media (max-width: 640px) {
      .wrap         { padding: 0 20px; }
      header        { padding: 36px 0 28px; flex-direction: column; align-items: flex-start; }
      .grid         { grid-template-columns: 1fr; }
      .toast-container { bottom: 20px; right: 16px; left: 16px; }
      .login-card   { margin: 20px; padding: 36px 28px; }
    }
  </style>
</head>
<body>

<!-- Login overlay -->
<div id="loginOverlay" class="login-overlay hidden">
  <div class="login-card">
    <div class="login-logo">
      <div class="logo-eyebrow">netlify</div>
      <h1>Projects<span class="dot">.</span></h1>
    </div>
    <form class="login-form" onsubmit="handleLogin(event)">
      <input
        id="pwdInput"
        class="login-input"
        type="password"
        placeholder="Password"
        autocomplete="current-password"
        autofocus
      />
      <button class="btn-unlock" id="btnUnlock" type="submit">Unlock</button>
    </form>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<div class="wrap">
  <!-- Header -->
  <header>
    <div>
      <div class="logo-eyebrow">netlify</div>
      <h1>Projects<span class="dot">.</span></h1>
    </div>
    <div class="status-badge" id="statusBadge">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">Connecting…</span>
    </div>
  </header>

  <div class="divider"></div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="count-label">
      <span class="num" id="countNum">—</span> projects
    </div>
    <button class="btn-refresh" id="btnRefresh" onclick="loadSites()">
      <svg width="13" height="13" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
        <path d="M13 7A6 6 0 1 1 7 1"/>
        <path d="M13 1v4h-4"/>
      </svg>
      Refresh
    </button>
  </div>

  <!-- Grid -->
  <div class="grid" id="grid"></div>

  <!-- Footer -->
  <footer>
    <span id="lastUpdated">—</span>
    <span>netlify api / v1</span>
  </footer>
</div>

<!-- Toasts -->
<div class="toast-container" id="toastContainer"></div>

<script>
  let sites = [];
  let appPassword = sessionStorage.getItem('app_pwd') ?? '';

  /* ── Auth ────────────────────────────────────── */
  function showLogin(errorMsg = '') {
    document.getElementById('loginOverlay').classList.remove('hidden');
    document.getElementById('loginError').textContent = errorMsg;
    document.getElementById('pwdInput').value = '';
    setTimeout(() => document.getElementById('pwdInput').focus(), 50);
  }

  function hideLogin() {
    document.getElementById('loginOverlay').classList.add('hidden');
  }

  async function handleLogin(e) {
    e.preventDefault();
    const pwd = document.getElementById('pwdInput').value.trim();
    if (!pwd) return;

    const btn = document.getElementById('btnUnlock');
    btn.disabled = true;
    btn.textContent = 'Checking…';

    try {
      const res = await fetch('/api/sites', {
        headers: { 'X-App-Password': pwd },
      });

      if (res.status === 401) {
        document.getElementById('loginError').textContent = 'Wrong password';
        document.getElementById('pwdInput').value = '';
        document.getElementById('pwdInput').focus();
        return;
      }

      appPassword = pwd;
      sessionStorage.setItem('app_pwd', pwd);
      hideLogin();

      const data = await res.json();
      if (res.ok) {
        sites = Array.isArray(data) ? data : [];
        renderCards(sites);
        setStatus('connected', `${sites.length} sites`);
        document.getElementById('countNum').textContent = sites.length;
        document.getElementById('lastUpdated').textContent =
          `Updated ${new Date().toLocaleTimeString()}`;
      }
    } catch (e) {
      document.getElementById('loginError').textContent = 'Connection failed';
    } finally {
      btn.disabled = false;
      btn.textContent = 'Unlock';
    }
  }

  /* 비밀번호 포함 fetch 래퍼 */
  async function apiFetch(url, opts = {}) {
    const res = await fetch(url, {
      ...opts,
      headers: { ...(opts.headers ?? {}), 'X-App-Password': appPassword },
    });
    if (res.status === 401) {
      sessionStorage.removeItem('app_pwd');
      appPassword = '';
      showLogin('Session expired. Please re-enter password.');
      throw new Error('Unauthorized');
    }
    return res;
  }

  /* ── Helpers ─────────────────────────────────── */
  function esc(str) {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  function timeAgo(dateStr) {
    if (!dateStr) return 'Never published';
    const diff = Math.floor((Date.now() - new Date(dateStr)) / 1000);
    if (diff < 60)          return 'Just now';
    if (diff < 3600)        return `${Math.floor(diff / 60)}m ago`;
    if (diff < 86400)       return `${Math.floor(diff / 3600)}h ago`;
    if (diff < 86400 * 30)  return `${Math.floor(diff / 86400)}d ago`;
    if (diff < 86400 * 365) return `${Math.floor(diff / 86400 / 30)}mo ago`;
    return `${Math.floor(diff / 86400 / 365)}y ago`;
  }

  function setStatus(state, text) {
    const badge = document.getElementById('statusBadge');
    const dot   = document.getElementById('statusDot');
    badge.className = `status-badge ${state}`;
    dot.className   = `status-dot ${state}`;
    document.getElementById('statusText').textContent = text;
  }

  function toast(msg, type = 'success') {
    const c = document.getElementById('toastContainer');
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    const color = type === 'success' ? '#22d3a0' : '#f04040';
    const icon  = type === 'success'
      ? `<svg width="15" height="15" viewBox="0 0 16 16" fill="none" stroke="${color}" stroke-width="1.6" stroke-linecap="round"><circle cx="8" cy="8" r="7"/><path d="M5 8l2 2 4-4"/></svg>`
      : `<svg width="15" height="15" viewBox="0 0 16 16" fill="none" stroke="${color}" stroke-width="1.6" stroke-linecap="round"><circle cx="8" cy="8" r="7"/><path d="M8 5v4M8 11v.5"/></svg>`;
    t.innerHTML = `${icon}<span>${esc(msg)}</span>`;
    c.appendChild(t);
    setTimeout(() => {
      t.style.animation = 'toastOut 0.3s cubic-bezier(.4,0,1,1) both';
      setTimeout(() => t.remove(), 300);
    }, 3200);
  }

  /* ── Render skeleton ─────────────────────────── */
  function renderSkeleton() {
    document.getElementById('grid').innerHTML =
      Array.from({ length: 6 }).map(() => `
        <div class="skeleton-card">
          <div class="sk" style="width:58%;height:16px"></div>
          <div class="sk" style="width:82%;height:12px"></div>
          <div class="sk" style="width:38%;height:11px"></div>
        </div>`).join('');
  }

  /* ── Render cards ────────────────────────────── */
  function renderCards(list) {
    const grid = document.getElementById('grid');

    if (!list.length) {
      grid.innerHTML = `
        <div class="empty-state">
          <svg width="44" height="44" viewBox="0 0 44 44" fill="none" stroke="currentColor" stroke-width="1.4">
            <rect x="6" y="6" width="32" height="32" rx="4"/>
            <path d="M16 22h12M22 16v12"/>
          </svg>
          <p>No projects found.<br>Deploy something on Netlify to get started.</p>
        </div>`;
      return;
    }

    grid.innerHTML = '';
    list.forEach((site, i) => {
      const card = document.createElement('div');
      card.className = 'card';
      card.style.animationDelay = `${i * 35}ms`;
      card.dataset.id   = site.id;
      card.dataset.name = site.name;

      const url       = site.ssl_url || site.url || '';
      const published = site.published_deploy?.published_at;
      const hasRepo   = !!site.build_settings?.repo_url;

      card.innerHTML = `
        <div class="card-main">
          <div class="card-top">
            <div class="site-name">${esc(site.name)}</div>
            <button class="btn-delete" onclick="startDelete(this)" title="Delete site">
              <svg width="13" height="13" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M1.5 3.5h11M4.5 3.5V2h5v1.5M5.5 6v4M8.5 6v4M2.5 3.5l1 8a1 1 0 001 .5h5a1 1 0 001-.5l1-8"/>
              </svg>
            </button>
          </div>
          ${url ? `<a href="${esc(url)}" target="_blank" rel="noopener" class="site-url">
            <svg width="10" height="10" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.4"><circle cx="6" cy="6" r="5"/><path d="M6 1c-2 2-2 8 0 10M6 1c2 2 2 8 0 10M1 6h10"/></svg>
            ${esc(url.replace(/^https?:\/\//, ''))}
          </a>` : ''}
          <div class="card-meta">
            <div class="meta-item">
              <svg width="11" height="11" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.4"><circle cx="6" cy="6" r="5"/><path d="M6 3v3l2 1.5"/></svg>
              ${timeAgo(published)}
            </div>
            ${hasRepo ? `<div class="meta-item">
              <svg width="11" height="11" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.4"><circle cx="3.5" cy="2.5" r="1.5"/><circle cx="8.5" cy="2.5" r="1.5"/><circle cx="3.5" cy="9.5" r="1.5"/><path d="M3.5 4v2.5a2 2 0 002 2h3"/></svg>
              Git connected
            </div>` : ''}
          </div>
        </div>

        <div class="card-confirm">
          <div>
            <div class="confirm-title">Delete <strong>"${esc(site.name)}"</strong>?</div>
            <div class="confirm-sub">Site and all deploys will be permanently removed.</div>
          </div>
          <div class="confirm-actions">
            <button class="btn-cancel" onclick="cancelDelete(this)">Cancel</button>
            <button class="btn-confirm-delete" onclick="confirmDelete(this)">Delete</button>
          </div>
        </div>`;

      grid.appendChild(card);
    });
  }

  /* ── Delete flow ─────────────────────────────── */
  function getCard(el) { return el.closest('.card'); }

  function startDelete(btn) {
    getCard(btn).classList.add('is-confirming');
  }

  function cancelDelete(btn) {
    getCard(btn).classList.remove('is-confirming');
  }

  async function confirmDelete(btn) {
    const card = getCard(btn);
    const { id, name } = card.dataset;

    card.classList.remove('is-confirming');
    card.classList.add('is-deleting');

    try {
      const res = await apiFetch(`/api/sites/${id}`, { method: 'DELETE' });
      if (!res.ok) {
        const d = await res.json().catch(() => ({}));
        throw new Error(d.error || `HTTP ${res.status}`);
      }

      card.classList.remove('is-deleting');
      card.classList.add('is-deleted');

      setTimeout(() => {
        card.remove();
        sites = sites.filter(s => s.id !== id);
        document.getElementById('countNum').textContent = document.querySelectorAll('.card:not(.is-deleted)').length;
      }, 400);

      toast(`"${name}" deleted`);
    } catch (e) {
      card.classList.remove('is-deleting');
      card.classList.add('is-confirming');
      toast(e.message, 'error');
    }
  }

  /* ── Load sites ──────────────────────────────── */
  async function loadSites() {
    const btn = document.getElementById('btnRefresh');
    btn.disabled = true;
    setStatus('loading', 'Loading…');
    renderSkeleton();

    try {
      const res  = await apiFetch('/api/sites');
      const data = await res.json();

      if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);

      sites = Array.isArray(data) ? data : [];
      renderCards(sites);

      setStatus('connected', `${sites.length} sites`);
      document.getElementById('countNum').textContent = sites.length;
      document.getElementById('lastUpdated').textContent =
        `Updated ${new Date().toLocaleTimeString()}`;
    } catch (e) {
      setStatus('error', 'Error');
      document.getElementById('grid').innerHTML = `
        <div class="error-state">
          <div class="err-title">Failed to load projects</div>
          <div class="err-msg">${esc(e.message)}</div>
        </div>`;
    } finally {
      btn.disabled = false;
    }
  }

  // 세션에 비밀번호 없으면 로그인 화면
  if (!appPassword) {
    showLogin();
  } else {
    loadSites();
  }
</script>
</body>
</html>
